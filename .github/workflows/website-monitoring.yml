name: Website Monitoring

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    # Allow manual triggering
  push:
    branches:
      - main
      - master
    paths:
      - 'config/websites.json'
      - 'tests/**'
      - 'src/**'
  pull_request:
    branches:
      - main
      - master

jobs:
  monitor:
    name: Monitor Websites
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Run monitoring tests
        id: run-tests
        run: npm test
        env:
          TESTMO_INSTANCE: ${{ secrets.TESTMO_INSTANCE }}
          TESTMO_PROJECT_ID: ${{ secrets.TESTMO_PROJECT_ID }}
          TESTMO_API_KEY: ${{ secrets.TESTMO_API_KEY }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_NOTIFICATION: ${{ secrets.SLACK_NOTIFICATION }}
          GIT_COMMIT: ${{ github.sha }}
          GIT_BRANCH: ${{ github.ref_name }}
          GIT_AUTHOR: ${{ github.actor }}
          GIT_REPOSITORY_URL: ${{ github.repositoryUrl }}
          NODE_ENV: production
        continue-on-error: true
      
      - name: Submit results to Testmo
        id: submit-testmo
        run: npm run testmo:submit
        env:
          TESTMO_INSTANCE: ${{ secrets.TESTMO_INSTANCE }}
          TESTMO_PROJECT_ID: ${{ secrets.TESTMO_PROJECT_ID }}
          TESTMO_API_KEY: ${{ secrets.TESTMO_API_KEY }}
          GIT_COMMIT: ${{ github.sha }}
          GIT_BRANCH: ${{ github.ref_name }}
          GIT_AUTHOR: ${{ github.actor }}
          GIT_REPOSITORY_URL: ${{ github.repositoryUrl }}
        continue-on-error: true
      
      - name: Check for failures and create GitHub Issues
        if: failure() || steps.run-tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const resultsPath = path.join(process.cwd(), 'test-results', 'results.json');
            if (!fs.existsSync(resultsPath)) return;
            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            const failures = results.suites?.flatMap(suite => 
              suite.specs?.flatMap(spec => 
                spec.tests?.filter(test => test.results?.some(r => r.status === 'failed'))
              ) || []
            ) || [];
            if (failures.length === 0) return;
            const screenshotsDir = path.join(process.cwd(), 'test-results', 'screenshots');
            const issues = [];
            if (fs.existsSync(screenshotsDir)) {
              const sites = fs.readdirSync(screenshotsDir);
              for (const site of sites) {
                const statusPath = path.join(screenshotsDir, site, 'status.json');
                if (fs.existsSync(statusPath)) {
                  const status = JSON.parse(fs.readFileSync(statusPath, 'utf8'));
                  if (!status.isUp) {
                    issues.push({
                      title: `ðŸš¨ Website Monitoring Alert: ${status.name} is DOWN`,
                      body: `## Website Monitoring Alert
**Website**: ${status.name}
**URL**: ${status.url}
**Status**: ${status.status}
**Error**: ${status.errorMessage || 'Unknown error'}
**Load Time**: ${status.loadTime || 'N/A'}ms
**Timestamp**: ${status.timestamp}
### Details
- **Final URL**: ${status.finalUrl || status.url}
- **DNS Resolution**: ${status.dns?.success ? 'Success' : 'Failed'}
- **SSL Certificate**: ${status.ssl?.valid ? 'Valid' : 'Invalid'}
### Test Run
- **Workflow**: ${{ github.workflow }}
- **Run ID**: ${{ github.run_id }}
- **Commit**: ${github.sha.substring(0, 7)}
---
*This issue was automatically created by the Website Monitoring workflow.*`,
                      labels: ['monitoring', 'website-down', 'automated']
                    });
                  }
                }
              }
            }
            for (const issue of issues) {
              try {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issue.title,
                  body: issue.body,
                  labels: issue.labels
                });
              } catch (error) {
                console.error(`Failed to create issue: ${error.message}`);
              }
            }
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 30
      
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: test-results/screenshots/
          retention-days: 7
      
      - name: Upload dashboard
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dashboard
          path: test-results/dashboard.html
          retention-days: 30
